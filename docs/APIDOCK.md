# API Documentation

The content is mapped by scenes and looked up by parcels. And a parcel may or may not point to a scene.

When looking up for content, the client is expected to search for all scenes in a region of parcels. Next step is to validate that all parcels of a scene still belong to the scene. And finally retrieve the content by CID. Basically the flow should go `GET /mappings` -> `GET /validate` -> `GET /contents/{cid}`

For uploading content, all the scene must be posted into `/mappings` after calculating its CID and signing it.

It is important noticing that if a parcel that belongs to a scene gets updated, then the other parcels of the old scene that do not belong to the new one will get out of date. The client is currently responsible for dealing with this issue.

### POST /mappings

Updates the scene of a set of parcels. Requires calculating the ipfs cid

Recieves a request with a `Content-Type:multipart/form-data` query parameter, and with the following parts:

- Metadata: is named `metadata` and has a JSON:

```
{
  "value": <root CID>,
  "signature": <signed root CID>, //hex value with 0x prefix
  "pubKey": <eth address>, //with 0x prefix
  "validityType": <int>, //???
  "validity": <timestamp>, //format: "2018-12-12T14:49:14.074000000Z"
  "sequence": <int> //???
}
```

- Content: is named `<root CID>` and has a JSON:

```
[
  {"cid": <file CID>, "name": <file path>},
  ...
]
```

- Files: the rest of the parts correspond to the uploaded files, they will be named `<file CID>` and have the `filename` header set to file's name.


### GET /mappings

This endpoint gets all the scenes from an area delimited by a northwest coordinate and a southeast coordinate. It expects the following query paramaters:

- `nw="-13,45"`
- `se="13,-45"`

It returns a JSON as follows:

```
[
  {
    "parcel_id: "-13,45"
    "contents": {
      <file1>: <file1 CID>,
      <file2>: <file2 CID>,
      ...
    }
  },
  ...
]
```

### GET /validate

This endpoint fetches the metadata from a parcel. It expects the following query paramaters:

- `x=-13`
- `y=16"`

It returns a JSON as follows:

```
{
  "value": <root CID>,
  "signature": <signed root CID>,
  "pubKey": <eth address>,
  "validityType": <int>,
  "validity": <timestamp>,
  "sequence": <int>,
  "root_cid": <root CID>
}
```

### GET /contents/{CID}

This endpoint gets a file by its `CID`.

## Examples

In the following examples we use the data generated by the `demo.sh` script and a local server.

```bash
$> curl 'http://localhost:8000/mappings' \
  -F 'metadata={"value": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn","signature": "0x96a6e3f69b25fcf89d5af9fb9d6f17da8dd86548f486822e74296af1d8bcaf920e67684e2a15cd942526a4ede10dd5483eccb381d92f88b932858d7a466f99ed1b","pubKey": "0xa08a656ac52c0b32902a76e122d2973b022caa0e","validityType": 0,"validity": "2018-12-12T14:49:14.074000000Z","sequence": 2}' \
  -F 'QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn=[{"cid": "QmaiT7TzzKVjgJ6PJnovQn9DYrFcFyLnFaBseMdyLHCtX8","name": "assets/"},{"cid": "QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672","name": "assets/test.txt"},{"cid": "QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox","name": "build.json"},{"cid": "QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on","name": "package.json"},{"cid": "QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4","name": "scene.json"},{"cid": "QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou","name": "scene.tsx"},{"cid": "Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc","name": "tsconfig.json"}]' \
  -F 'QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672=@demo/assets/test.txt' \
  -F 'QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox=@demo/build.json' \
  -F 'QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on=@demo/package.json' \
  -F 'QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4=@demo/scene.json' \
  -F 'QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou=@demo/scene.tsx' \
  -F 'Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc=@demo/tsconfig.json'
```

```bash
$> curl 'http://localhost:8000/contents/QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672'
something

$> curl 'http://localhost:8000/contents/QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox'
[
  {
    "name": "Compile systems",
    "kind": "Webpack",
    "file": "./scene.tsx",
    "target": "webworker"
  }
]
```

```bash
$> curl 'http://localhost:8000/validate?x=-0&y=0'
Not Found

$> curl 'http://localhost:8000/validate?x=54&y=-136'
{
  "pubkey": "0xa08a656ac52c0b32902a76e122d2973b022caa0e",
  "rootcid": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn",
  "sequence": "2",
  "signature": "0x96a6e3f69b25fcf89d5af9fb9d6f17da8dd86548f486822e74296af1d8bcaf920e67684e2a15cd942526a4ede10dd5483eccb381d92f88b932858d7a466f99ed1b",
  "validity": "2018-12-12T14:49:14.074000000Z",
  "validityType": "0",
  "value": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn"
}
```

```bash
$> curl 'http://localhost:8000/mappings?nw=53,-135&se=55,-137'
[
  {
    "parcel_id": "54,-136",
    "contents": {
      "build.json": "QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox",
      "package.json": "QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on",
      "scene.json": "QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4",
      "scene.tsx": "QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou",
      "test.txt": "QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672",
      "tsconfig.json": "Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc"
    }
  }
]
```

# New endpoints

Two new endpoints were added to get the contents.

1. `/scenes`

2. `/parcel_info`

Instead of getting the mappings through the `/mappings` endpoint as before, now we will get the `root_cid` of the scene of the parcels on `/scenes` and later we can get the mappings for that scene in the `parcel_info` endpoint.

### GET /scenes

It receives two x's values and two y's values that will limit a rectangle. It will get all the root cid of the parcels within that rectangle. If for a scene there are parcels outside the queried rectangle, it will return those parcels as well

* Example

```$ curl -H "Content-type: application/json" "https://content.decentraland.zone/scenes?x1=7&y1=9&x2=9&y2=9"```

Response:
```
[
    {"7,9":"QmQpy26Rt758mozFpndPNE752QyyhSuY6YJ1xmZqJJtNv5"},
    {"8,9":"QmVND7pVw9KrXqqvAZkavpFA7Pe5xiWSbXCufMnjoeRUwu"},
    {"9,9":"QmT7WfCMCqHcGPM5rh7hnhXr791sAMVQgWqubvyc4BeuBB"},
    {"7,8":"QmQpy26Rt758mozFpndPNE752QyyhSuY6YJ1xmZqJJtNv5"},
    {"6,9":"QmQpy26Rt758mozFpndPNE752QyyhSuY6YJ1xmZqJJtNv5"},
    {"6,8":"QmQpy26Rt758mozFpndPNE752QyyhSuY6YJ1xmZqJJtNv5"}
]
```
### GET /parcel_info

With the root cid (hash of the previous request) we can query the `/parcel_info` endpoint

* Example

```$ curl -H "Content-type: application/json" "https://content.decentraland.zone/parcel_info?cids=QmVND7pVw9KrXqqvAZkavpFA7Pe5xiWSbXCufMnjoeRUwu"```

Response

```
[{"QmVND7pVw9KrXqqvAZkavpFA7Pe5xiWSbXCufMnjoeRUwu":{"parcel_id":"8,9","contents":[{"file":"models/Mushroom_02/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockMedium_02/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/Mushroom_01/Mushroom_01.glb","hash":"QmPFQV4W7ine8GYEGgx7TrcgQ67E9buf23YnChDQSn6cqM"},{"file":"models/Flower_03/Flower_03.glb","hash":"QmU7rfY5cSf7qmbik8iSFWHfdfgHnhkrMTnGSPaBgNuvpY"},{"file":"models/RockLarge_02/RockLarge_02.glb","hash":"QmWc1bwcQRaMc3goS3ZjAvtnZjsVMbMxWhjNsnUipANY56"},{"file":"models/HTC_Portal/HTC_Portal.glb","hash":"QmcWLpSSCJzvBBraNJ9EGmSrNY9WWKjNq4HuKGkw7d1Dtn"},{"file":"models/RockLarge_02/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/BushPatch_01/BushPatch_01.glb","hash":"QmQyj3nVn49BYDjiqgC1C5PKBQLmfCo79wwEo8adwbhZ7Y"},{"file":"models/RockSmall_03/RockSmall_03.glb","hash":"QmeSsZpUZxVbLNyVpiwVrKoaNmGiSVehA78fxjoSoXPDc8"},{"file":"models/FloorBaseGrass_01/FloorBaseGrass_01.glb","hash":"QmSyvWnb5nKCaGHw9oHLSkwywvS5NYpj6vgb8L121kWveS"},{"file":"builder.json","hash":"QmXm1YtjvE9PFDvzzivzsdkmGHH34vi4JsQN9t39qUv84k"},{"file":"models/Flower_03/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockSmallMoss_01/RockSmallMoss_01.glb","hash":"QmTnAtKqUJCqfRhNVPL3DzZEe9npt7wvWmoV4gb4Lto52s"},{"file":"models/Mushroom_02/Mushroom_02.glb","hash":"QmcLrsMQNcsvrakQJrjmd1VR6rpHqQ5rRnjr823DfUPnTZ"},{"file":"models/RockSmall_03/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/TreePine_01/TreePine_01.glb","hash":"QmP1eadGzG9kkmUQhjXLnn9oXQz934we5zhUvnwQJHPEEV"},{"file":"models/RockMedium_01/RockMedium_01.glb","hash":"QmZ1VuhSrB73QPD85bFf5Typ81fPBS5amQ7XbR5uhW5TFb"},{"file":"models/HTC_Portal/TX_EXodus.png.png","hash":"QmR2DNkLrsHevQiwS5bQ9rsjFc9XWidCQRsNU12inFCo15"},{"file":"models/RockMedium_02/RockMedium_02.glb","hash":"QmaB4WeRc1nBnN8VGejuZXt9bMHdmDGnQK6U1pAfZqRkGb"},{"file":"models/RockMedium_03/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockMedium_03/RockMedium_03.glb","hash":"QmPV4WN5piBCe4yXHHMQhAwy6NxtyyFhGrfaDkcjMibhiU"},{"file":"scene.json","hash":"QmWcZJ4xXabrq4TzoRP2nYvbPZfMX8D8Zg7d8AP1ysveoS"},{"file":"models/Flower_04/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/Plant_05/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockMediumMoss_01/RockMediumMoss_01.glb","hash":"QmQa6TnJdkULMt4N1hv22uamN7QnoejLsUQSAjszYAdbcQ"},{"file":"models/TreePine_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/Flower_04/Flower_04.glb","hash":"QmecsnERbYDiKMHJfeD1Y6CWXBkSyUo4iYKN2iq5ZSHiVP"},{"file":"models/Mushroom_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockMediumMoss_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockSmallMoss_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/Grass_04/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/Pond_02/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/RockMedium_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/ConstructionLadder_01/ConstructionLadder_01.glb","hash":"QmUgLMT1nLYa3WMJW8Wis64vt2DstJFgDZJD5cKhag84qZ"},{"file":"models/Pond_02/Pond_02.glb","hash":"QmXMqSY9Q5zECDXjbkPG2t3mTfRoq2RFge5C8zJPdZGiaR"},{"file":"models/Bridge_04/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"models/BushPatch_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"},{"file":"bin/game.js","hash":"QmYDgg31AxMXgGkYFFxQaJzRB2EiP8DUtRKdYhdvLqhT1E"},{"file":"models/Bridge_04/Bridge_04.glb","hash":"QmYJSvT3nyzdDASWr9YkmvCGzmqj66mDh6qVfTcv5jYxcp"},{"file":"models/FloorBaseGrass_01/Floor_Grass01.png.png","hash":"QmT1WfQPMBVhgwyxV5SfcfWivZ6hqMCT74nxdKXwyZBiXb"},{"file":"models/Plant_05/Plant_05.glb","hash":"QmVwkiRQNQA2wZ68693jH29eCMYwoUNmSZsNh8LJpBJNG6"},{"file":"models/Grass_04/Grass_04.glb","hash":"QmYkGZkPMewjqrdrCYiZYtpjyVSh1aj5QdJjCyZRL2WV8q"},{"file":"models/ConstructionLadder_01/file1.png","hash":"QmYACL8SnbXEonXQeRHdWYbfm8vxvaFAWnsLHUaDG4ABp5"}],"root_cid":"QmVND7pVw9KrXqqvAZkavpFA7Pe5xiWSbXCufMnjoeRUwu","publisher":"0xb79248c11f1b531f4dcecba0ecaebdd55e51ca6c"}}]
```

The content of the query appears as `{"file": <filename>. "hash": <hash>}`. It is as is used to be in the `/mappings` endpoint.

Multiple cids can be queried at the same time with comma separated arguments, as in:

```$ curl -H "Content-type: application/json" "https://content.decentraland.zone/parcel_info?cids=QmVND7pVw9KrXqqvAZkavpFA7Pe5xiWSbXCufMnjoeRUwu,QmQpy26Rt758mozFpndPNE752QyyhSuY6YJ1xmZqJJtNv5"```