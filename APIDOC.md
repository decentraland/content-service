// TODO: exactly who can sign the content
// TODO: what is being signed
// TODO: validityType and sequence
// TODO: replay attack on /mappings?

# API Documentation

Content is mapped by scenes and looked up by parcels. Each parcel may or may not point to a scene.

When a player uses the client to navigate Decentraland, the client is expected to engage with this API to look up the content on all scenes that are in a region of parcels. 

The next step is for the client to engage with this API to validate that all parcels of a scene still belong to the scene. And the final step, is for the client to retrieve the content by CID. 

Basically, the flow should go like this:

`GET /mappings` -> `GET /validate` -> `GET /contents/{cid}`

For uploading content, all the scene must be posted in `/mappings`, after calculating its CID and signing it with the public key of the scene owner or update operator.

It's important to notice that if a parcel that used to belong to a multi-parcel scene is gets updated, but not the other parcels in that old scene, then those other parcels will remain outdated. The client is currently responsible for dealing with this issue.

## Endpoints

The following endpoints are exposed by the content service. You can find these enpoints both in your own instances of the service and in our instances, deployed at `content.server.org`, and `content.server.today`.

### POST /mappings

Updates the content for a scene that belongs to a set of parcels. Requires calculating the IPFS CID

Recieves a request with a `Content-Type:multipart/form-data` query parameter, and with the following parts:

- Metadata: is named `metadata` and has a JSON:

```
{
  "value": <root CID>,
  "signature": <signed root CID>, //hex value with 0x prefix
  "pubKey": <eth address>, //with 0x prefix
  "validityType": <int>, //???
  "validity": <timestamp>, //format: "2018-12-12T14:49:14.074000000Z"
  "sequence": <int> //???
}
```

- Content: is named `<root CID>` and has a JSON:

```
[
  {"cid": <file CID>, "name": <file path>},
  ...
]
```

- Files: the rest of the parts correspond to the uploaded files, they will be named `<file CID>` and have the `filename` header set to file's name.


### GET /mappings

This endpoint gets all the scenes from an area delimited by a northwest coordinate and a southeast coordinate. It expects the following query paramaters:

- `nw="-13,45"`
- `se="13,-45"`

It returns a JSON as follows:

```
[
  {
    "parcel_id: "-13,45"
    "contents": {
      <file1>: <file1 CID>,
      <file2>: <file2 CID>,
      ...
    }
  },
  ...
]
```

### GET /validate

This endpoint fetches the metadata from a parcel. It expects the following query paramaters:

- `x=-13`
- `y=16"`

It returns a JSON as follows:

```
{
  "value": <root CID>,
  "signature": <signed root CID>,
  "pubKey": <eth address>,
  "validityType": <int>,
  "validity": <timestamp>,
  "sequence": <int>,
  "root_cid": <root CID>
}
```

You can use this request's response to validate that the contents of the scene haven't been changed since the parcel owner or update operator signed it. You can also verify that the root CID corresponds to the contents of the folder by downloading each of the files (using the `/contents` endpoint) and generating a new CID for them that matches the root CID.

### GET /contents/{CID}

This endpoint gets a file by its `CID`.

## Examples

In the following examples we use the data generated by the `demo.sh` script and a local server.

```bash
$> curl 'http://localhost:8000/mappings' \
  -F 'metadata={"value": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn","signature": "0x96a6e3f69b25fcf89d5af9fb9d6f17da8dd86548f486822e74296af1d8bcaf920e67684e2a15cd942526a4ede10dd5483eccb381d92f88b932858d7a466f99ed1b","pubKey": "0xa08a656ac52c0b32902a76e122d2973b022caa0e","validityType": 0,"validity": "2018-12-12T14:49:14.074000000Z","sequence": 2}' \
  -F 'QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn=[{"cid": "QmaiT7TzzKVjgJ6PJnovQn9DYrFcFyLnFaBseMdyLHCtX8","name": "assets/"},{"cid": "QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672","name": "assets/test.txt"},{"cid": "QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox","name": "build.json"},{"cid": "QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on","name": "package.json"},{"cid": "QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4","name": "scene.json"},{"cid": "QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou","name": "scene.tsx"},{"cid": "Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc","name": "tsconfig.json"}]' \
  -F 'QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672=@demo/assets/test.txt' \
  -F 'QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox=@demo/build.json' \
  -F 'QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on=@demo/package.json' \
  -F 'QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4=@demo/scene.json' \
  -F 'QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou=@demo/scene.tsx' \
  -F 'Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc=@demo/tsconfig.json'
```

```bash
$> curl 'http://localhost:8000/contents/QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672'
something

$> curl 'http://localhost:8000/contents/QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox'
[
  {
    "name": "Compile systems",
    "kind": "Webpack",
    "file": "./scene.tsx",
    "target": "webworker"
  }
]
```

```bash
$> curl 'http://localhost:8000/validate?x=-0&y=0'
Not Found

$> curl 'http://localhost:8000/validate?x=54&y=-136'
{
  "pubkey": "0xa08a656ac52c0b32902a76e122d2973b022caa0e",
  "rootcid": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn",
  "sequence": "2",
  "signature": "0x96a6e3f69b25fcf89d5af9fb9d6f17da8dd86548f486822e74296af1d8bcaf920e67684e2a15cd942526a4ede10dd5483eccb381d92f88b932858d7a466f99ed1b",
  "validity": "2018-12-12T14:49:14.074000000Z",
  "validityType": "0",
  "value": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn"
}
```

```bash
$> curl 'http://localhost:8000/mappings?nw=53,-135&se=55,-137'
[
  {
    "parcel_id": "54,-136",
    "contents": {
      "build.json": "QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox",
      "package.json": "QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on",
      "scene.json": "QmfRoY2437YZgrJK9s5Vvkj6z9xH4DqGT1VKp1WFoh6Ec4",
      "scene.tsx": "QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou",
      "test.txt": "QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672",
      "tsconfig.json": "Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc"
    }
  }
]
```
