# Content Service

## Requirements

- [Go 1.11](https://golang.org/dl/)
- [Docker Compose](https://docs.docker.com/compose/)

## Configuration

In the base dir you can find the `config.yml` as follows:

```
server:
  url: 'localhost'  # hostname of the server
  port: '8000'      # port to use

s3Storage: true     # if true store in S3 else use local storage

localStorage: 'tmp'   # local storage dir

redis:
 address: 'content_service_redis:6379'    # address of the redis server
 password: ''                             # password
 DB: 0
```

**Note**: If you use `s3Storage: true` you need to set AWS environment variables: `AWS_REGION`, `AWS_ACCESS_KEY`, and `AWS_SECRET_KEY`.

## Running

First start Redis

```
$ make ops
```

Then you can either build or build and run:

```
$ make build

$ make run
```

This (`make run`) will start an instance of the content service server.

## Endpoints

### POST /mappings

This endpoint recieves a request with `Content-Type:multipart/form-data` with the following parts:

- Metadata: is named `metadata` and has a JSON:

```
{"value": <root CID>, "signature": <signed root CID>, "pubKey": <eth address>, "validityType": <int>, "validity": <timestamp>, "sequence": <int>}
```

- Content: is named `<root CID>` and has a JSON:

```
[{"cid": <file CID>, "name": <file path>}, ...]
```

- Files: the rest of the parts correspond to the uploaded files, they will be named `<file CID>` and have the `filename` header set to file's name.


### GET /mappings

This endpoint gets all the scenes from an area delimited by a northwest coordinate and a southeast coordinate. It expects the following query paramaters:

- `nw="-13,45"`
- `se="13,-45"`

You will receive a JSON as follows:

```
[
  {
    "parcel_id: "-13,45"
    "contents": {
      <file1>: <file1 CID>,
      <file2>: <file2 CID>,
      ...
    }
  },
  ...
]
```

### GET /validate

This endpoint gets the metadata from a parcel. It expects the following query paramaters:

- `x=-13`
- `y=16"`

You will receive a JSON as follows:

```
{
  "value": <root CID>,
  "signature": <signed root CID>,
  "pubKey": <eth address>,
  "validityType": <int>,
  "validity": <timestamp>,
  "sequence": <int>,
  "root_cid": <root CID>
}
```

### GET /contents/{CID}

This endpoint gets a file by its `CID`.

## Demo

To run the demo script you need to:

1. Have Redis up `$ make ops`
1. Set your AWS environment variables: `AWS_REGION`, `AWS_ACCESS_KEY`, `AWS_SECRET_KEY`
1. Start the demo server `$ make demo`

After, you can run the demo script as:

```
$ ./demo.sh`.
<a href="https://content-service.s3.amazonaws.com/text.txt">Moved Permanently</a>.
```

## Examples

For the following examples we will use the data generated by the `demo.sh` script and a local server.

```bash
$> curl 'http://localhost:8000/mappings' \
  -F 'metadata={"value": "QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn","signature": "0x96a6e3f69b25fcf89d5af9fb9d6f17da8dd86548f486822e74296af1d8bcaf920e67684e2a15cd942526a4ede10dd5483eccb381d92f88b932858d7a466f99ed1b","pubKey": "0xa08a656ac52c0b32902a76e122d2973b022caa0e","validityType": 0,"validity": "2018-12-12T14:49:14.074000000Z","sequence": 2}' \
  -F 'QmeoVuRM2ynxMfBn6eEqeTVRkJR9KZBQbLMLakZjioNhdn=[{"cid": "QmaiT7TzzKVjgJ6PJnovQn9DYrFcFyLnFaBseMdyLHCtX8","name": "assets/"},{"cid": "QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672","name": "assets/test.txt"},{"cid": "QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox","name": "build.json"},{"cid": "QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on","name": "package.json"},{"cid": "QmYTMBFq77WdSvsceAwVfgitRJhzSzGvKSMt5b61LkzwVt","name": "scene.json"},{"cid": "QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou","name": "scene.tsx"},{"cid": "Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc","name": "tsconfig.json"}]' \
  -F 'QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672=@demo/assets/test.txt' \
  -F 'QmbGdhmRstTdbNBKxqVbGpjiPxy2A5nqrDLuk9KFmQtwox=@demo/build.json' \
  -F 'QmTBetsUR4WC1fUB3oM7sDCBQZiHXrsp4LXarqTnHFZ9on=@demo/package.json' \
  -F 'QmYTMBFq77WdSvsceAwVfgitRJhzSzGvKSMt5b61LkzwVt=@demo/scene.json' \
  -F 'QmSXv3Qgr8pjoYNXZqMhE5Lo9f8FXpYF5cN7vndXsYqJou=@demo/scene.tsx' \
  -F 'Qmdv1drP1dkNFKjX6YqL91Go4mY141ZSFQy311qidk9HJc=@demo/tsconfig.json'
```

```bash
$> curl 'http://localhost:8000/contents/QmbdQuGbRFZdeqmK3PJyLV3m4p2KDELKRS4GfaXyehz672'
```

```bash
$> curl 'http://localhost:8000/validate?x=-0&y=0'
```

```bash
$> curl 'http://localhost:8000/validate?x=54&y=-136'
```

```bash
$> curl 'http://localhost:8000/mappings?nw=53,-135&se=55,-137'
```
